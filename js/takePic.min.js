!function(j){function init(a){var b=document.createElement("input");b.setAttribute("type","file"),b.setAttribute("accept","image/*;capture=camera"),b.setAttribute("id","takePic"),b.setAttribute("capture","camera"),a.opts.multiple&&b.setAttribute("multiple","true"),a.opts.obj.appendChild(b),a.inp=b,events(a)}function events(a){a.inp.addEventListener("change",function(b){var c=b.target.files||b.dataTransfer.files,d=[];try{for(var e=0;e<c.length;e++){var f=c[e];if(!f.type||a.opts.type.indexOf(f.type.toLowerCase())<0)a.error("您选择的文件格式不支持");else if(!f.size||f.size>a.opts.maxSize)a.error("您选择的文件过大");else{var g=window.URL||window.webkitURL,h=g.createObjectURL(f),i=new Image;i.src=h,i.file=f,d.push(i);var j=function(){d.length==c.length&&requestUpload(c,a)};readExif(f,function(b){zoomImg(i,b,a,j)})}}c.index=a.opts.fileContainer.index++,c.uploaded=!1,a.opts.fileContainer.fileLists[c.index]=c,a.opts.fileContainer.length++,a.opts.onSelect({index:c.index,target:c})}catch(b){return!1}},!1)}function overlay(a,b){var c=document.createElement("div"),d=document.createElement("div"),e=document.createElement("img"),f=document.createElement("p");c.style.cssText+=styles(0)+styles(5),d.style.cssText+=styles(1),e.style.cssText+=styles(3),f.style.cssText+=styles(4),e.src=images(b?1:0),f.innerHTML=a,d.appendChild(e),d.appendChild(f),c.appendChild(d),document.body.appendChild(c),setTimeout(function(){c.style.cssText+=styles(2)},600),c.onclick=function(){g()},setTimeout(function(){g()},3600);var g=function(){c.style.cssText+=styles(5),c&&j.transitionend(c,function(){document.body.removeChild(c)})}}function styles(a){var b="";switch(a){case 0:b="width: 100%;height: 100%;position: fixed;z-index: 9999;background: rgba(255,255,255,.2);top: 0;left: 0;-webkit-transition: all 0.6s;-moz-transition:all 0.6s;-o-transition:all 0.6s;transition:all 0.6s;";break;case 1:b="width: 200px;height: 120px;background: rgba(0,0,0,0.9);border-radius: 8px;overflow: hidden;position: absolute;top: 50%;left: 50%;margin: -60px 0 0 -100px;color:rgb(255,255,255);text-align:center;";break;case 2:b="-webkit-transform: scale(1,1);-ms-transform:scale(1,1) ;-moz-transform:scale(1,1) ;-o-transform:scale(1,1) ;transform: scale(1,1);";break;case 3:b="display: block;margin: 18px auto;";break;case 4:b="max-width: 96%;margin: 0 auto;height: 42px;overflow: hidden;word-break: break-all;";break;case 5:b="-webkit-transform: scale(0,0);-ms-transform:scale(0,0) ;-moz-transform:scale(0,0) ;-o-transform:scale(0,0) ;transform: scale(0,0);"}return b}function images(a){var b="";switch(a){case 0:b="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAALEgAACxIB0t1+/AAAABZ0RVh0Q3JlYXRpb24gVGltZQAwNS8yNy8xNcKDZtAAAAAcdEVYdFNvZnR3YXJlAEFkb2JlIEZpcmV3b3JrcyBDUzVxteM2AAABeElEQVRYhe2Xu3GDQBCGP904pwWXQAMaKAF1gDtQfNFFF6sD0wGUAOMGKMEtUIEcLCcBAoMQDwf+Zkh43P7s3uPfw/V6ZRLG+kAEhIAPeJ03KqAEciDD6HLKsIdRAcZGwBkIpim9UQAXjM7mCTD2HUhmBO4TEmP0d99DNRA8QtL5anDqMcp6zAkCjI2BlMcav4IHpPXYLdolEJXp6HDhUa4m+Zdc45ya8+KegXvN1yapY3UESPAl0z6ER+NHRYCkfokJN5XATUqXgfOGwR1nESA73JZ/7wgw1lfI9roXkUL29r0IFXKw7IWv2GbpDeH1nwUb8i9AIU5mL6o35pz700++MUqFeLi9yBXwq2dbmUwMibE5z5ThNUPiKDA6dKvg8syXC3GBmx/QGeJet6Jwtqy5D8RssySrOhZtAeLb4+7bK9DqER4bE7HOnysF/8DopHmjpy/QCXBi2XJUiB1Pug8GOiOdIT5hiYlZAP5Qj/iHm9NHIau05z8fDYFS/ByQ1gAAAABJRU5ErkJggg==";break;case 1:b="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAALEgAACxIB0t1+/AAAABZ0RVh0Q3JlYXRpb24gVGltZQAwNS8yNy8xNcKDZtAAAAAcdEVYdFNvZnR3YXJlAEFkb2JlIEZpcmV3b3JrcyBDUzVxteM2AAACvUlEQVRYhc2XvW9SURiHH27qTWpLiJASXW51oEsXXGTqR6IutANNlw6aUDa3+ge0Me1idHFjkuCqAwzVxaWkiQmTjKYMKhptNBBJSxOxLQ7ncOXCuZcb7m3ib4LzHs7z43y85z2BTqeDG+VqiTiQAhaBOBDq69IEKsAeUMwY5YqbcQPDDORqiRSwASy4cvpPJeBZxigXRzKQqyWuA/kRwCoj6YxR/qQKajbwFGI6vcKRY1TkmMMN5GqJNFBgcI29KAQU5NgWWZZAuiz4CFZppXdfmAbkmlfw95+r1ATi3T3RuwR5P+G6FmR6XLmFQpKFaUBOvR8bzlQymuX21BNiE8uq8EJ3U3ZnYMNP+Fxki7Aek583mYtsqbptAASef74VB977CY9NLA20V1uv2a9v9zff1BDp9ULhAJFLM6rmlIbI7Z41G1yzhTfaVd78eKAKLWqIi0UpXQsyG1wbCo9NLJO48tAR3j4/UoXjY9gcPV0LkoxmCesxwvqMav1M+FxkUxlrnx87wQFCyrugFy4gS9yZeoquBS39pscXvMABm8uoF96VMT5PMpo1TYT1GbvjZcIb7QNHuK2B+h/1D8N6jGQ0y43Ld6WZSU9wEHngF4p94HSkoAMElJH9+g7V1q4rONDUEBeQYqBt9us7Nr/zBQ5Q0RA1nFLV1q6DCc9wgD0NcKzZqq1diof3Oe+c2vb5cFwYBQ5Q1GT1WnLq1WgfUKo/Qqy9VUenX3nXeDwKvJQxypXuKXg2rPfHk7cUv9/jrPPbAn/1bXUUuMnsrYj2cFETTI5dZfXaS07OfnqBlzJGeRFgrKcxjYuS7Pj0kBdf5kcFgyjJ0t0vZiKSNVp6oLv/srwRLJlQVqvrFwhf738pDaTijFHOAyuIqfJLTUQ5nu8PKO8C6TLOkOPpUiVEGa7MN//v41Rh5EKe538BX5YeOGFX/xYAAAAASUVORK5CYII="}return b}function readExif(a,b){var c=new FileReader;c.readAsArrayBuffer(a),c.onload=function(a){var c=a.target.result,d=new DataView(c),e=d.getUint16(54,!0)||1;(e>8||1>e)&&(e=1),b(e)}}function zoomImg(a,b,c,d){var e,f,g=document.createElement("canvas");a.onload=function(){var h=a.width,i=a.height,j=h/i;h=h>c.opts.zoomWidth?c.opts.zoomWidth:h,i=h/j,1==b||3==b?(g.width=h,g.height=i,e=g.getContext("2d"),3==b?(e.translate(g.width,g.height),e.scale(-1,-1),e.drawImage(a,g.width-h,g.height-i,a.width,a.height,0,0,h,i)):e.drawImage(a,0,0,a.width,a.height,0,0,h,i)):(6==b||8==b)&&(h=parseInt(1.4*h),i=parseInt(1.4*i),g.width=i,g.height=h,e=g.getContext("2d"),6==b?(e.rotate(90*Math.PI/180),e.translate(0,-i)):(e.rotate(-90*Math.PI/180),e.translate(-h,0)),e.drawImage(a,0,0,a.width,a.height,0,0,h,i)),f=g.toDataURL("image/jpeg",c.opts.quality),a.file.base64Resize=f,d(a)}}function requestUpload(files,obj){var self=obj.opts,httpRequest=new XMLHttpRequest;if(httpRequest.upload){httpRequest.upload.addEventListener("progress",function(a){self.onProgress({total:a.total,loaded:a.loaded,index:files.index,target:files})},!1),httpRequest.onreadystatechange=function(e){if(4==httpRequest.readyState){if(200!=httpRequest.status)return obj.error("服务器连接失败"),self.onFailure({index:files.index,target:files}),!1;if(!httpRequest.responseText)return obj.error("无返回值"),!1;var json=eval("("+httpRequest.responseText+")");if(0!=json.error)return obj.error(json.error),self.onFailure({index:files.index,target:files}),!1;for(var i=0;i<files.length;i++)files[i].serverData=json.files[files[i].name];files.uploaded=!0,self.fileContainer.fileLists[files.index]=files,obj.succ("上传成功"),self.onSuccess({index:files.index,target:files})}},httpRequest.open("POST",self.uploadURL,!0);for(var formData=new FormData,i=0;i<files.length;i++)formData.append("takepic["+i+"][name]",files[i].name),formData.append("takepic["+i+"][size]",files[i].size),formData.append("takepic["+i+"][data]",files[i].base64Resize);httpRequest.send(formData)}}var takePic=function(a){if(!a.obj||!a.uploadURL)return void this.error("配置错误");var b={obj:{},uploadURL:"",type:"image/jpg,image/jpeg,image/png,image/gif",maxSize:8388608,multiple:0,zoomWidth:1024,quality:.8,onProgress:function(){},onSuccess:function(){},onFailure:function(){},onSelect:function(){},fileContainer:{length:0,index:1,fileLists:{}}};this.opts=j.concat(b,a),init(this)};takePic.prototype.error=function(a){overlay(a,0)},takePic.prototype.succ=function(a){overlay(a,1)},window.takePic=takePic}(jFaver);
